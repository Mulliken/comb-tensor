import numpy as np
from fishbonett.backwardSpinBosonMultiChannel import SpinBoson, SpinBoson1D, calc_U
from fishbonett.stuff import sigma_x, sigma_z, temp_factor, sd_zero_temp, drude1, lemmer, drude, _num, sigma_1
from time import time

bath_length = 200
phys_dim = 20
bond_dim = 1000
a = [phys_dim]*bath_length
print(a)
pd = a[::-1] + [2]
coup_num_1 = [13.31251869073255, 2.909518215236111, -3.4232554179266814, 4.11444510137433, 5.1230939866752285, -9.097781538078161, -0.4396924444234138, 0.12572330108942417, -15.324393268465075, -0.3737961219655992, -3.916699043991135, -9.737718552211685, -1.8369270391768788, 0.8101099827750942, 2.4072348498371694, 1.7849543941857373, 118.0808915558487, 47.46030115358914, 27.396944755708173, 41.622099354780325, 106.85559480525252, -19.519314306061883, -195.68839910374226, -136.70124107877209, -21.040123399860704, 600.7851114926536, 36.53030137393154, -0.2775336922648563, -31.562515310057012, -113.88032743578549, 71.75612317211112, 41.844131552111044, -91.9479429965456, -92.07972416799466, -23.454357113487823, -176.65311588016218, -9.498651045544008, -3.2618202932654166, -1.0040438068043147, 74.24746044867078, 28.90362151642025, 20.839992768864864, 54.02856299393599, 75.80326530905043, 88.07668967386205, 116.05562535104274, -131.97060515214116, -42.74731377147283, 113.44262497541688, 226.20812951374532, 120.98022915454843, -0.7230356437026655, -81.60210692496129, -28.137264621696048, 38.07503546592436, -83.97050051579478, 49.016144760082994, 212.499954152641, 88.57348871577258, -270.73063331339455, 164.43516645923168, 172.12905355242566, -11.58941350148692, -114.07010624073695, 3.8901230402200775, -8.472278175058165, 15.85719634168597, 12.574608999014547, 58.903730821496964, -23.08475251588023, -17.51970399129426, -7.863557831791796, -27.515257689545557, 3.184955901917716, -3.7170811034504188, 18.63328039290177, -20.784960419348213, 23.20216474170367, -62.142135760648415, 5.325636328098367, 1.7711281040003173, -0.4180916478959144, -84.68951843022235, -25.947628757197513, 1.446581763339943, 39.414930526020605, -349.95827482451404, 253.90626211734778, -102.60330095692474, 65.06840890884455, -2.0249765712012815, -47.92662510835979, 105.56223886634979, -16.58360974077326, -7.409160181932685, -14.858563882197219, 38.13469004469691, -6.335848333908097, 178.31860633592026, -137.17429737043446, 3.984076152184067, 61.1182863305799, -44.59859945343365, -71.014952217524, -36.90069094287281, -6.057453665633768, 279.92287533485865, 13.344941112986492, -302.485095415862, 143.63013725122235, 226.8412374246169, -15.719687879500382, 6.909853126906956, 16.934989902193728, 2.5666912988250243, 55.4703724515456, 11.408842460737867, 267.1603304680495, 50.182128827281126, -1.601218260153489, 4.2410187996521085, -289.26995021411096, -244.1007292476142, 3.038135030789686, -17.457797200737616, 2.51532349485838, -33.33418827699535, -30.851165794732033, 20.87529218397462, 4.704041577973478, 112.75580789043023, 7.884986055563242, -29.766000419294674, 24.04804490487757, -22.44315778768218, -9.49876753014707, 16.619991599144296, 6.1255624606947, -23.285783401879744, -2.388651401453893, -0.990329018576171, -263.75640114540033, -98.3411504427607, 229.2860381311377, 88.9640457543296, -9.409195870837914, -228.98086536251745, -37.231185745561554, -14.287836749227775, 168.78076357329883, 154.00343127379847, 22.777513436629153, -217.21071226897615, 30.906667813399483, -49.32563841542598, 213.46917896670035, 162.3977739554672, 614.2830356812213, -327.6687783273993, -227.55789242274042, -24.569466531634184, -324.4055100171676]
coup_num_2 = [13.81527766494167, 27.79103263246515, 0.38634603901037834, -36.953810295603, 30.815183750930334, -6.34577034771768, 15.459693057119184, 9.599312732474665, -27.6862414565345, -25.093969627803837, 15.36457112467743, -49.0415644590636, 30.29611928007124, 13.44847910246321, -8.729828523439389, 13.568304916832675, 279.09953543680825, 97.80787814725734, 33.45869257905427, 33.83910852646725, 214.74878420226324, -26.89439249510647, -320.55885949976204, -221.34111723526647, -72.32221420457292, 808.9651413843136, 58.62985638166738, 12.052397495728197, -139.3003168652902, 38.83531410428675, -5.409123938226091, 55.846926200743965, -100.42061260803894, -60.23390752610273, -9.929132219396836, -227.1663812266854, 11.84659616670468, -31.843185818600745, 4.523484556139531, 63.42209918958562, -7.23962303591669, 47.1818656444059, 104.900098836611, 119.55842075247202, 4.6059172890652516, 183.97611303470012, -215.9824169284256, -56.888290404506016, 141.9212745416435, 243.3680543271461, 267.14875516920995, -8.224055319001263, -136.4632048379392, -33.357816111556645, 15.241793427563115, -163.19770027706363, 31.191310141558414, 301.3404625269795, 55.9358490406791, -392.6162325745268, 237.27887510622193, 161.58832031844477, 55.229834661767, -78.63565811998726, 15.751883529426879, -15.648746266800028, 2.5919308158216086, 25.853491310566454, 19.636027301640766, -29.64556550656034, -5.806776278974808, -11.579741064026607, -21.965152255893933, -35.912648923023234, -26.627418742607663, 7.935246106587179, 16.180451849369863, 74.74340199592639, -236.01083521478236, 20.42645728886895, -9.762642363452892, 16.642861456361626, -329.5360678500164, -1.6191286373345386, -28.88730340720521, 30.958999257309276, -358.8270535507879, 347.8806674448099, -90.03920801503776, 61.57788994671097, 23.83429163715471, -105.45478588683018, -26.188604130057247, -109.05134239715596, 49.16162565337301, -22.129873794099872, 75.81372236811475, -93.94857737307912, 369.8598406463813, -225.30911896402944, 22.424849380940483, 41.99753973309983, -67.3456632531013, -58.19008828630878, -56.143139506166214, 60.487639648356314, 332.1041811059135, 55.624555398325015, -24.925735847160766, 36.58924856421931, 105.194676806934, -26.23249173160313, -11.085546807714286, 22.028117148651663, 1.3720254992265053, 39.485926043427455, -29.77892711255636, 133.84110342544264, 29.380075751812768, 9.771087862529443, 9.478914102040441, 45.82419128895528, 153.88545057406466, -18.71408653621271, -60.01357840569455, 3.9861381322748226, -68.06498982373847, 20.854915118062625, -12.367480397119133, -22.856884982363784, -339.07010723828023, 32.16397128121188, -65.64854300666921, 8.622517445540943, 15.907819350406903, 8.800303898959283, 101.10719595678518, 44.140505543960636, -22.016873528101193, 92.06647168584927, 24.85183029096482, 290.2087847251723, -163.5874367807624, 352.1800838116153, 103.0204485902576, 2.7355193303545633, -283.48359563504937, -24.29099306119987, -8.73921044272243, 212.62690768474303, 252.54155931482703, -36.23354098834102, -185.7707675955155, 2.415320264459802, 168.33734513374347, 410.10511444852426, 208.4999508200004, 625.1926972473776, -451.3928782681816, -334.8902770280611, -48.41267965977601, -378.15102733134614]
coup_num_1 = [22.87208, -5.10531, -4.28719, 3.8601, -3.83818, -14.34437, -4.15779, 0.2489, -32.66833, 2.7068, -3.46199, -1.77908, -29.64192, 7.10642, -13.89889, -6.03304, 66.28702, 24.1279, 33.37544, 21.71101, -9.01773, 10.15688, -55.98164, 41.1621, 65.82669, 219.75465, 16.41902, 0.31749, 28.49923, -38.21912, 2.01525, -4.50427, 92.59139, 9.81323, -35.68768, 7.9295, 8.27103, 10.25305, 6.57326, -11.1044, -11.17794, 0.88247, 41.63233, 23.15775, -85.27496, 33.38605, -4.74469, 32.59479, -55.12039, 80.44047, 36.30003, -3.24138, -12.10284, -57.3605, 31.6798, 28.41721, -14.59751, -25.80586, 19.08764, -10.00132, 1.77979, -52.98917, 37.65909, -39.50747, 16.91541, 0.0, -3.14663, -1.8901, 35.19624, -11.05915, -5.9694, -2.65872, -33.55222, -25.29957, 3.45775, 29.54999, 45.91598, -2.12556, 0.70994, 0.0, -35.13331, 42.34509, -42.59541, -9.50493, -8.14375, -23.71353, 173.40521, 18.05668, -9.53746, 12.80712, 7.28674, 2.4374, -28.60954, 36.15296, 0.0, -8.35093, 2.51589, -153.14519, 252.22287, 82.85594, 5.14632, -6.94096, 6.07829, -20.89076, 18.44276, -16.76692, -91.11283, 2.67074, 546.19544, -115.47619, -377.02934, 37.92921, 8.55953, -37.17402, -6.71186, -16.37235, -0.97934, -464.27217, 90.62281, 5.06642, 6.08819, -632.59258, 597.32138, 6.36396, 58.72522, -11.79171, 48.5252, 82.70604, -7.69191, -5.64978, 959.04893, -76.06701, -199.0647, -14.14496, -77.44587, -136.71485, 78.08934, 0.0, -66.62007, 9.77504, 26.25346, -91.93307, 33.54868, -6.71398, -11.26421, 0.0, -6.76701, 4.51417, -9.03682, -27.12744, -13.56796, 0.0, 0.0, 0.0, 2.2684, 24.96794, -9.08774, 40.89481, -22.76177, 15.95799, 13.68676, 77.58234]
coup_num_2 = [23.19452, -46.10336, -3.8311, 80.68725, -40.84319, -7.79585, 12.59216, 12.88066, -56.85139, -52.176, 20.05921, 32.33741, 19.34644, 24.4461, -18.63368, -16.08809, 281.71983, 78.56522, 19.81667, 48.79602, 103.35709, -4.11112, 104.51745, -25.76131, -0.56993, 64.94069, -5.16895, -2.53993, 226.37458, -414.76055, -228.73137, -52.66531, 132.22331, 72.69058, -24.76288, 95.53154, 9.84646, -3.28098, 23.41726, -32.88612, -7.30866, 3.52988, -28.36488, 61.13645, 33.08482, 27.27311, 25.62131, 52.05437, -140.75385, -5.60029, 162.56102, -18.90804, 2.75065, -72.80371, 3.33472, 69.65002, 26.94925, -72.25641, -41.06735, 74.71573, 83.05676, 51.20302, 117.22911, -23.45756, 52.62572, -34.57399, 14.47448, -12.60064, 34.55631, -31.87637, -15.91839, -8.64084, -57.03877, -52.65046, 49.79163, 34.47499, 52.27358, 12.04486, -16.32851, -0.71206, -60.94553, 44.49823, -346.53889, 26.32134, 33.31534, -14.82096, 127.46024, 5.26653, -54.84037, 63.23515, 11.33492, 11.37452, -384.18526, 33.68798, 5.76151, 1.67019, 10.06354, -89.19445, 12.73853, -59.79295, -0.85772, -59.86578, 17.36654, -106.19471, -7.90404, -168.55163, 24.76854, -4.45124, 218.1085, 15.83141, -202.65327, 109.04647, 6.65741, -131.53883, -42.18882, -158.90811, 13.7108, -304.52261, 65.4498, 1.01328, -8.11759, -133.99744, -4.19173, 11.66726, 127.06002, -12.86369, -6.47003, 188.26506, 46.15145, -20.33922, 398.73186, -83.08858, -240.04861, -3.53624, -196.59336, -280.62523, 252.28863, 4.83095, -87.21172, 196.72276, 31.25412, -1259.35718, 42.495, -8.95197, -11.26421, 2.25496, -4.51134, 4.51417, 0.0, -47.47303, -22.61327, 2.26203, 9.04814, 2.26769, 6.8052, 63.55476, -2.27193, 29.53514, -25.03794, 2.27971, 15.96789, 75.30051]


coup_num_1 = [0.48541591, 1.18842969, 2.05375192, 3.02445022, 4.03624924,
       5.01477679, 5.88638096, 6.59560352, 7.11788283, 7.45966629,
       7.64804817, 7.7179109 , 7.70261393, 7.6295959 , 7.5194941 ,
       7.38697896, 7.2420968 , 7.09154427, 6.93968452, 6.78929257,
       6.64207813, 6.49904338, 6.36072454, 6.22735381, 6.09896753,
       5.97547832, 5.85672302, 5.74249456, 5.63256297, 5.52668911,
       5.4246336 , 5.32616238, 5.23105013, 5.13908219, 5.05005546,
       4.96377877, 4.88007269, 4.79876917, 4.719711  , 4.64275116,
       4.56775218, 4.49458544, 4.4231305 , 4.35327448, 4.28491142,
       4.21794171, 4.1522716 , 4.0878126 , 4.02448112, 3.96219793,
       3.90088784, 3.84047927, 3.78090393, 3.72209646, 3.66399413,
       3.60653659, 3.54966552, 3.49332442, 3.43745837, 3.38201371,
       3.3269379 , 3.27217922, 3.21768654, 3.16340911, 3.10929634,
       3.05529749, 3.00136146, 2.94743654, 2.89347006, 2.83940813,
       2.7851953 , 2.73077414, 2.67608488, 2.62106491, 2.56564823,
       2.50976483, 2.45334001, 2.39629349, 2.3385384 , 2.27998012,
       2.22051478, 2.16002749, 2.09839016, 2.03545869, 1.97106951,
       1.90503504, 1.8371378 , 1.76712254, 1.69468554, 1.61945975,
       1.54099352, 1.45871919, 1.37190505, 1.27957813, 1.18039295,
       1.07239126, 0.95251581, 0.81547626, 0.65044123, 0.42627515]

freq_num = [6.0, 20.0, 43.0, 53.0, 59.0, 63.0, 84.0, 88.0, 120.0, 132.0, 144.0, 148.0, 160.0, 201.0, 216.0, 237.0, 279.0, 282.0, 295.0, 304.0, 327.0, 342.0, 390.0, 396.0, 403.0, 410.0, 430.0, 449.0, 458.0, 470.0, 475.0, 490.0, 496.0, 514.0, 515.0, 534.0, 557.0, 580.0, 581.0, 604.0, 608.0, 624.0, 647.0, 655.0, 659.0, 665.0, 671.0, 688.0, 696.0, 720.0, 744.0, 764.0, 778.0, 780.0, 786.0, 788.0, 794.0, 811.0, 818.0, 832.0, 839.0, 842.0, 859.0, 873.0, 886.0, 889.0, 890.0, 891.0, 905.0, 920.0, 938.0, 940.0, 949.0, 967.0, 978.0, 995.0, 999.0, 1002.0, 1004.0, 1007.0, 1014.0, 1015.0, 1021.0, 1034.0, 1047.0, 1048.0, 1048.0, 1064.0, 1124.0, 1132.0, 1145.0, 1149.0, 1156.0, 1162.0, 1164.0, 1181.0, 1186.0, 1190.0, 1201.0, 1208.0, 1213.0, 1227.0, 1228.0, 1231.0, 1242.0, 1248.0, 1251.0, 1259.0, 1307.0, 1317.0, 1333.0, 1341.0, 1345.0, 1348.0, 1356.0, 1362.0, 1385.0, 1412.0, 1424.0, 1433.0, 1435.0, 1469.0, 1482.0, 1500.0, 1510.0, 1516.0, 1525.0, 1539.0, 1554.0, 1598.0, 1644.0, 1655.0, 1656.0, 1667.0, 1685.0, 1696.0, 1699.0, 1708.0, 1713.0, 1728.0, 1768.0, 1781.0, 3163.0, 3165.0, 3186.0, 3189.0, 3190.0, 3192.0, 3195.0, 3197.0, 3198.0, 3199.0, 3199.0, 3207.0, 3208.0, 3210.0, 3213.0, 3213.0, 3219.0, 3224.0, 3226.0, 3227.0]

coup_mat = [np.diag([x, -x]) for x, y in zip(coup_num_1, coup_num_2)]
# freq_num = [6.115, 19.75, 42.785, 53.035, 59.049, 62.948, 83.663, 87.539, 120.173, 131.58, 143.899, 148.496, 159.891, 201.192, 215.966, 236.831, 278.94, 282.06, 294.762, 303.878, 326.674, 342.415, 390.459, 396.117, 403.132, 409.609, 429.697, 449.173, 457.858, 469.744, 475.314, 489.934, 495.985, 514.18, 515.125, 533.989, 556.77, 579.688, 581.172, 603.909, 607.718, 624.123, 646.965, 655.423, 659.333, 665.403, 670.972, 688.064, 696.46, 719.703, 744.377, 763.996, 777.71, 780.284, 785.892, 787.852, 793.612, 811.478, 817.532, 831.652, 838.931, 842.258, 859.346, 873.155, 886.345, 888.753, 889.866, 890.658, 905.02, 920.056, 938.208, 940.357, 948.667, 966.807, 977.952, 995.335, 999.164, 1001.667, 1004.16, 1007.414, 1013.639, 1015.056, 1020.89, 1033.982, 1046.905, 1047.962, 1048.283, 1063.799, 1123.949, 1132.104, 1144.712, 1149.057, 1156.337, 1161.604, 1163.757, 1181.27, 1185.69, 1190.34, 1201.471, 1207.704, 1213.014, 1227.291, 1227.998, 1230.663, 1242.207, 1247.526, 1251.137, 1258.572, 1306.564, 1316.516, 1333.095, 1340.534, 1344.534, 1347.979, 1355.751, 1362.395, 1385.265, 1412.373, 1423.885, 1432.681, 1435.431, 1469.188, 1481.761, 1500.239, 1510.151, 1516.427, 1524.746, 1539.361, 1553.56, 1597.505, 1643.892, 1655.17, 1656.462, 1666.857, 1685.082, 1696.391, 1698.825, 1708.27, 1712.974, 1727.554, 1768.309, 1780.63, 3163.355, 3164.762, 3186.09, 3189.269, 3190.201, 3191.791, 3194.869, 3196.625, 3197.522, 3199.217, 3199.423, 3206.869, 3207.606, 3210.26, 3213.09, 3213.323, 3218.568, 3224.412, 3225.867, 3226.448]
reorg = sum([(coup_num_1[i]-coup_num_2[i]) ** 2 / freq_num[i] for i in range(len(freq_num))])

print("Reorg",reorg)
# exit()
temp = 300
eth = SpinBoson(pd, coup_mat=coup_mat, freq=freq_num, temp=temp)
etn = SpinBoson1D(pd)
# set the initial state of the system. It's in the high-energy state |0>:
# if you doubt this, pls check the definition of sigma_z
etn.B[-1][0, 1, 0] = 0.
etn.B[-1][0, 0, 0] = 1.


# spectral density parameters

eth.h1e =  120 * sigma_x

eth.build(n=0)
# exit()
# print(eth.w_list,eth.k_list)
#
# print(len(eth.w_list))
# exit()

# b = np.array([np.abs(eth.get_dk(t=i*0.2/100)) for i in range(100)])
# print(b.shape)
reorg = eth.get_dk(1, star=True)

print(reorg)
# exit()
# coef = eth.get_dk(1, star=True)
# indexes = np.abs(freq).argsort()
# bj = bj[indexes]
# bj = np.array(bj)
# print(b.shape)
# b.astype('float32').tofile('./DA2/dk.dat')
# bj.astype('float32').tofile('./output/j0.dat')
# freq.astype('float32').tofile('./output/freq.dat')
# coef.astype('float32').tofile('./DA2/coef.dat')

# print(freq)
# print(coef)
# exit()


# U_one = eth.get_u(dt=0.002, t=0.2)

# ~ 0.5 ps ~ 0.1T
p = []


threshold = 1e-4
dt = 0.001/8
num_steps = 50*4

s_dim = np.empty([0,0])
num_l = np.empty([0,0])
t = 0.
tt0=time()
for tn in range(num_steps):
    U1, U2 = eth.get_u(2*tn*dt, 2*dt, factor=2)

    t0 = time()
    etn.U = U1
    for j in range(bath_length-1,0,-1):
        print("j==", j, tn)
        etn.update_bond(j, bond_dim, threshold, swap=1)

    etn.update_bond(0, bond_dim, threshold, swap=0)
    etn.update_bond(0, bond_dim, threshold, swap=0)
    t1 = time()
    t = t + t1 - t0

    t0 = time()
    etn.U = U2
    for j in range(1, bath_length):
        print("j==", j, tn)
        etn.update_bond(j, bond_dim, threshold,swap=1)

    dim = [len(s) for s in etn.S]
    s_dim = np.append(s_dim, dim)
    print("Length", len(dim))
    theta = etn.get_theta1(bath_length) # c.shape vL i vR
    rho = np.einsum('LiR,LjR->ij',  theta, theta.conj())
    sigma_z = np.diag([1,0])
    pop = np.einsum('ij,ji', rho, sigma_z)
    p = p + [pop]
    t1 = time()
    t = t + t1 - t0
    numExp = []
    for i, pd in enumerate(a[::-1]):
        theta = etn.get_theta1(i)
        rho = np.einsum('LiR,LjR->ij', theta, theta.conj())
        numExp.append(np.einsum('ij,ji', rho, _num(pd)).real)
    num_l = np.append(num_l, numExp)
tt1 = time()
print(tt1-tt0)
pop = [x.real for x in p]
print("population", pop)
pop = np.array(pop)

s_dim.astype('float32').tofile('./output/dim.dat')
pop.astype('float32').tofile('./output/pop.dat')
num_l.astype('float32').tofile('./output/num_ic.dat')